<div class="tile-manager-container">
  <div class="tile-manager-header">
    {{#if hasTiles}}
      <div class="tile-count-info">
        <strong>{{localize "EMPUZZLES.TotalTiles"}}:</strong> {{tileCount}}
        {{#if regionCount}}
          <span class="region-count-separator">|</span>
          <strong>{{localize "EMPUZZLES.Regions"}}:</strong> {{regionCount}}
        {{/if}}
      </div>
    {{/if}}
    <div class="header-actions">
      <button type="button" class="import-tile-btn" data-action="importTile" title="{{localize 'EMPUZZLES.ImportTile'}}">
        <i class="gi-load"></i> {{localize "EMPUZZLES.ImportTile"}}
      </button>
      <button type="button" class="refresh-tiles-btn" data-action="refreshTiles" title="{{localize 'EMPUZZLES.Refresh'}}">
        <i class="gi-clockwise-rotation"></i> {{localize "EMPUZZLES.Refresh"}}
      </button>
      <button type="button" class="view-variables-btn" data-action="viewVariables" title="{{localize 'EMPUZZLES.SceneVariables'}}">
        <i class="gi-scroll-unfurled"></i> {{localize "EMPUZZLES.SceneVariables"}}
      </button>
    </div>
  </div>

  <div class="tile-creation-cards">
    <button type="button" class="create-tile-card create-switch-card" data-action="createSwitch">
      <div class="card-icon">
        <i class="gi-lever"></i>
      </div>
      <div class="card-content">
        <h3 class="card-title">{{localize "EMPUZZLES.CreateSwitch"}}</h3>
        <p class="card-description">{{localize "EMPUZZLES.CreateSwitchDesc"}}</p>
      </div>
    </button>
    <button type="button" class="create-tile-card create-light-card" data-action="createLight">
      <div class="card-icon">
        <i class="gi-candle-flame"></i>
      </div>
      <div class="card-content">
        <h3 class="card-title">{{localize "EMPUZZLES.CreateLight"}}</h3>
        <p class="card-description">{{localize "EMPUZZLES.CreateLightDesc"}}</p>
      </div>
    </button>
    <button type="button" class="create-tile-card create-reset-card" data-action="createReset">
      <div class="card-icon">
        <i class="gi-clockwise-rotation"></i>
      </div>
      <div class="card-content">
        <h3 class="card-title">{{localize "EMPUZZLES.CreateResetTile"}}</h3>
        <p class="card-description">{{localize "EMPUZZLES.CreateResetTileDesc"}}</p>
      </div>
    </button>
    <button type="button" class="create-tile-card create-trap-card" data-action="createTrap">
      <div class="card-icon">
        <i class="gi-spikes"></i>
      </div>
      <div class="card-content">
        <h3 class="card-title">{{localize "EMPUZZLES.CreateTrap"}}</h3>
        <p class="card-description">{{localize "EMPUZZLES.CreateTrapDesc"}}</p>
      </div>
    </button>
    <button type="button" class="create-tile-card create-teleport-card" data-action="createTeleport">
      <div class="card-icon">
        <i class="gi-portal"></i>
      </div>
      <div class="card-content">
        <h3 class="card-title">{{localize "EMPUZZLES.CreateTeleport"}}</h3>
        <p class="card-description">{{localize "EMPUZZLES.CreateTeleportDesc"}}</p>
      </div>
    </button>
    {{#if hasEnhancedRegionBehaviors}}
      <button type="button" class="create-tile-card create-elevation-card" data-action="createElevation">
        <div class="card-icon">
          <i class="gi-mountaintop"></i>
        </div>
        <div class="card-content">
          <h3 class="card-title">{{localize "EMPUZZLES.CreateElevation"}}</h3>
          <p class="card-description">{{localize "EMPUZZLES.CreateElevationDesc"}}</p>
        </div>
      </button>
    {{/if}}
    {{#if experimentalFeatures}}
      <button type="button" class="create-tile-card create-utility-card" data-action="createCheckState">
        <div class="card-icon">
          <i class="gi-diagram"></i>
        </div>
        <div class="card-content">
          <h3 class="card-title">{{localize "EMPUZZLES.CreateCheckStateTile"}}</h3>
          <p class="card-description">{{localize "EMPUZZLES.CreateCheckStateTileDesc"}}</p>
        </div>
      </button>
    {{/if}}
  </div>

  {{#unless hasEnhancedRegionBehaviors}}
    <div class="enhanced-region-info">
      <i class="gi-info"></i>
      <div class="info-content">
        <strong>{{localize "EMPUZZLES.EnhancedRegionModuleTitle"}}</strong>
        <p>{{localize "EMPUZZLES.EnhancedRegionModuleDescription"}}</p>
      </div>
    </div>
  {{/unless}}

  <div class="tile-manager-controls">
    <div class="search-group">
      <div class="search-input-wrapper">
        <input type="text" class="tile-search-input" id="tile-search" value="{{searchQuery}}" placeholder="{{localize 'EMPUZZLES.SearchPlaceholder'}}" />
        <button type="button" class="search-clear-btn" title="{{localize 'EMPUZZLES.ClearSearch'}}" style="{{#if searchQuery}}display: block;{{else}}display: none;{{/if}}">
          <i class="gi-cancel"></i>
        </button>
      </div>
    </div>
    <div class="sort-group">
      <label for="tile-sort">{{localize "EMPUZZLES.SortBy"}}:</label>
      <select class="tile-sort-select" id="tile-sort">
        <option value="name" {{#if (eq sortBy "name")}}selected{{/if}}>{{localize "EMPUZZLES.Name"}}</option>
        <option value="x" {{#if (eq sortBy "x")}}selected{{/if}}>{{localize "EMPUZZLES.PositionX"}}</option>
        <option value="y" {{#if (eq sortBy "y")}}selected{{/if}}>{{localize "EMPUZZLES.PositionY"}}</option>
        <option value="elevation" {{#if (eq sortBy "elevation")}}selected{{/if}}>{{localize "EMPUZZLES.Elevation"}}</option>
        <option value="sort" {{#if (eq sortBy "sort")}}selected{{/if}}>{{localize "EMPUZZLES.SortOrder"}}</option>
      </select>
    </div>
  </div>

  {{#if hasTiles}}

    <div class="tile-list-scroll">
      {{#each tiles as |item|}}
        {{#if item.isGroup}}
          {{! Group header }}
          <div class="tile-group" data-base-tag="{{item.baseTag}}">
            <div class="group-header" data-action="toggleGroup" data-base-tag="{{item.baseTag}}">
              <i class="gi-expand group-toggle-icon"></i>
              <strong class="group-name">{{item.groupName}}</strong>
              <span class="group-count">({{item.tileCount}})</span>
            </div>
            {{#if item.expanded}}
              <div class="group-tiles">
                {{#each item.tiles as |tile|}}
                  <div class="tile-entry tile-entry-grouped {{#if tile.isRegion}}is-region{{/if}}" data-tile-id="{{tile.id}}" data-item-type="{{tile.itemType}}">
                    <div class="tile-header">
                      <div class="tile-info">
                        {{#if tile.isRegion}}
                          <div class="tile-thumbnail region-thumbnail" style="background-color: {{tile.color}};">
                            <i class="gi-chess-queen"></i>
                          </div>
                        {{else}}
                          {{#if tile.image}}
                            {{#if tile.isVideo}}
                              <video src="{{tile.image}}" class="tile-thumbnail" autoplay loop muted></video>
                            {{else}}
                              <img src="{{tile.image}}" class="tile-thumbnail" alt="" />
                            {{/if}}
                          {{else}}
                            <img src="icons/svg/hazard.svg" class="tile-thumbnail tile-thumbnail-placeholder" alt="" />
                          {{/if}}
                        {{/if}}
                        <div class="tile-details">
                          <strong class="tile-name">
                            {{tile.name}}
                            {{#if tile.isRegion}}<i class="fa-regular fa-game-board item-type-icon" title="{{localize 'EMPUZZLES.Region'}}"></i>{{else}}<i class="fa-solid fa-cubes item-type-icon" title="Tile"></i>{{/if}}
                          </strong>
                          <div class="tile-meta">
                            <span class="tile-position">{{localize "EMPUZZLES.Position"}}: ({{tile.x}}, {{tile.y}})</span>
                            <span class="tile-size">{{localize "EMPUZZLES.Size"}}: {{tile.width}}x{{tile.height}}</span>
                            <span class="tile-elevation">Elevation: {{tile.elevation}}</span>
                            {{#unless tile.isRegion}}<span class="tile-sort">Sort: {{tile.sort}}</span>{{/unless}}
                          </div>
                        </div>
                      </div>
                      <div class="tile-actions">
                        {{#if tile.isRegion}}
                          <button type="button" class="tile-action-btn" data-action="selectRegion" data-region-id="{{tile.id}}" title="{{localize 'EMPUZZLES.SelectRegion'}}">
                            <i class="gi-convergence-target"></i>
                          </button>
                          <button type="button" class="tile-action-btn" data-action="editRegion" data-region-id="{{tile.id}}" title="{{localize 'EMPUZZLES.EditRegion'}}">
                            <i class="gi-pencil"></i>
                          </button>
                          <button type="button" class="tile-action-btn delete-btn" data-action="deleteRegion" data-region-id="{{tile.id}}" data-region-name="{{tile.name}}" title="{{localize 'EMPUZZLES.DeleteRegion'}}">
                            <i class="gi-trash-can"></i>
                          </button>
                        {{else}}
                          <button type="button" class="tile-action-btn toggle-btn {{#unless tile.hidden}}active{{/unless}}" data-action="toggleVisibility" data-tile-id="{{tile.id}}" title="{{localize 'EMPUZZLES.ToggleVisibility'}}">
                            {{#if tile.hidden}}
                              <i class="gi-sight-disabled"></i>
                            {{else}}
                              <i class="gi-look-at"></i>
                            {{/if}}
                          </button>
                          {{#if tile.hasMonksData}}
                            <button type="button" class="tile-action-btn toggle-btn {{#if tile.active}}active{{/if}}" data-action="toggleActive" data-tile-id="{{tile.id}}" title="{{localize 'EMPUZZLES.ToggleActive'}}">
                              {{#if tile.active}}
                                <i class="gi-confirmed"></i>
                              {{else}}
                                <i class="gi-cancel-circle"></i>
                              {{/if}}
                            </button>
                          {{/if}}
                          <button type="button" class="tile-action-btn" data-action="selectTile" data-tile-id="{{tile.id}}" title="{{localize 'EMPUZZLES.SelectTile'}}">
                            <i class="gi-convergence-target"></i>
                          </button>
                          <button type="button" class="tile-action-btn" data-action="editTile" data-tile-id="{{tile.id}}" title="{{localize 'EMPUZZLES.EditTile'}}">
                            <i class="gi-pencil"></i>
                          </button>
                          <button type="button" class="tile-action-btn export-btn" data-action="exportTile" data-tile-id="{{tile.id}}" data-tile-name="{{tile.name}}" title="{{localize 'EMPUZZLES.ExportTile'}}">
                            <i class="gi-save"></i>
                          </button>
                          <button type="button" class="tile-action-btn delete-btn" data-action="deleteTile" data-tile-id="{{tile.id}}" data-tile-name="{{tile.name}}" title="{{localize 'EMPUZZLES.DeleteTile'}}">
                            <i class="gi-trash-can"></i>
                          </button>
                        {{/if}}
                      </div>
                    </div>

                    {{#if tile.variables.length}}
                      <div class="tile-variables">
                        {{#each tile.variables as |variable|}}
                          <div class="variable-item">
                            <code>{{variable.key}} = {{variable.displayValue}}</code>
                          </div>
                        {{/each}}
                      </div>
                    {{/if}}

                    {{#if tile.hasTags}}
                      <div class="tile-tags">
                        {{#each tile.tags as |tag|}}
                          <span class="tag-badge">{{tag}}</span>
                        {{/each}}
                      </div>
                    {{/if}}

                    <div class="tile-status">
                      {{#if tile.isRegion}}
                        <span class="status-badge region-badge">
                          <i class="fa-regular fa-game-board"></i> {{localize "EMPUZZLES.Region"}}
                        </span>
                        {{#if tile.actionCount}}
                          <span class="status-badge">
                            <i class="gi-lightning-bolt"></i> {{tile.actionCount}} Behaviors
                          </span>
                        {{/if}}
                      {{else}}
                        {{#if tile.hasMonksData}}
                          <span class="status-badge monks-active">
                            <i class="gi-jigsaw-piece"></i> {{localize "EMPUZZLES.MonksActiveTile"}}
                          </span>
                          {{#if tile.actionCount}}
                            <span class="status-badge">
                              <i class="gi-lightning-bolt"></i> {{tile.actionCount}} {{localize "EMPUZZLES.Actions"}}
                            </span>
                          {{/if}}
                          {{#if tile.variableCount}}
                            <span class="status-badge">
                              <i class="gi-code-fork"></i> {{tile.variableCount}} {{localize "EMPUZZLES.Variables"}}
                            </span>
                          {{/if}}
                          {{#unless tile.active}}
                            <span class="status-badge inactive">
                              <i class="gi-pause-button"></i> {{localize "EMPUZZLES.Inactive"}}
                            </span>
                          {{/unless}}
                        {{/if}}
                      {{/if}}
                      {{#if tile.hidden}}
                        <span class="status-badge hidden">
                          <i class="gi-sight-disabled"></i> {{localize "EMPUZZLES.Hidden"}}
                        </span>
                      {{/if}}
                      {{#if tile.locked}}
                        <span class="status-badge locked">
                          <i class="gi-padlock"></i> {{localize "EMPUZZLES.Locked"}}
                        </span>
                      {{/if}}
                    </div>
                  </div>
                {{/each}}
              </div>
            {{/if}}
          </div>
        {{else}}
          {{! Individual tile (not in a group) }}
          <div class="tile-entry" data-tile-id="{{item.id}}">
            <div class="tile-header">
              <div class="tile-info">
                {{#if item.image}}
                  {{#if item.isVideo}}
                    <video src="{{item.image}}" class="tile-thumbnail" autoplay loop muted></video>
                  {{else}}
                    <img src="{{item.image}}" class="tile-thumbnail" alt="" />
                  {{/if}}
                {{else}}
                  <img src="icons/svg/hazard.svg" class="tile-thumbnail tile-thumbnail-placeholder" alt="" />
                {{/if}}
                <div class="tile-details">
                  <strong class="tile-name">{{item.name}}</strong>
                  <div class="tile-meta">
                    <span class="tile-position">{{localize "EMPUZZLES.Position"}}: ({{item.x}}, {{item.y}})</span>
                    <span class="tile-size">{{localize "EMPUZZLES.Size"}}: {{item.width}}x{{item.height}}</span>
                    <span class="tile-elevation">Elevation: {{item.elevation}}</span>
                    <span class="tile-sort">Sort: {{item.sort}}</span>
                  </div>
                </div>
              </div>
              <div class="tile-actions">
                <button type="button" class="tile-action-btn toggle-btn {{#unless item.hidden}}active{{/unless}}" data-action="toggleVisibility" data-tile-id="{{item.id}}" title="{{localize 'EMPUZZLES.ToggleVisibility'}}">
                  {{#if item.hidden}}
                    <i class="gi-sight-disabled"></i>
                  {{else}}
                    <i class="gi-look-at"></i>
                  {{/if}}
                </button>
                {{#if item.hasMonksData}}
                  <button type="button" class="tile-action-btn toggle-btn {{#if item.active}}active{{/if}}" data-action="toggleActive" data-tile-id="{{item.id}}" title="{{localize 'EMPUZZLES.ToggleActive'}}">
                    {{#if item.active}}
                      <i class="gi-confirmed"></i>
                    {{else}}
                      <i class="gi-cancel-circle"></i>
                    {{/if}}
                  </button>
                {{/if}}
                <button type="button" class="tile-action-btn" data-action="selectTile" data-tile-id="{{item.id}}" title="{{localize 'EMPUZZLES.SelectTile'}}">
                  <i class="gi-convergence-target"></i>
                </button>
                <button type="button" class="tile-action-btn" data-action="editTile" data-tile-id="{{item.id}}" title="{{localize 'EMPUZZLES.EditTile'}}">
                  <i class="gi-pencil"></i>
                </button>
                <button type="button" class="tile-action-btn export-btn" data-action="exportTile" data-tile-id="{{item.id}}" data-tile-name="{{item.name}}" title="{{localize 'EMPUZZLES.ExportTile'}}">
                  <i class="gi-save"></i>
                </button>
                <button type="button" class="tile-action-btn delete-btn" data-action="deleteTile" data-tile-id="{{item.id}}" data-tile-name="{{item.name}}" title="{{localize 'EMPUZZLES.DeleteTile'}}">
                  <i class="gi-trash-can"></i>
                </button>
              </div>
            </div>

            {{#if item.variables.length}}
              <div class="tile-variables">
                {{#each item.variables as |variable|}}
                  <div class="variable-item">
                    <code>{{variable.key}} = {{variable.displayValue}}</code>
                  </div>
                {{/each}}
              </div>
            {{/if}}

            {{#if item.hasTags}}
              <div class="tile-tags">
                {{#each item.tags as |tag|}}
                  <span class="tag-badge">{{tag}}</span>
                {{/each}}
              </div>
            {{/if}}

            <div class="tile-status">
              {{#if item.hasMonksData}}
                <span class="status-badge monks-active">
                  <i class="gi-jigsaw-piece"></i> {{localize "EMPUZZLES.MonksActiveTile"}}
                </span>
                {{#if item.actionCount}}
                  <span class="status-badge">
                    <i class="gi-lightning-bolt"></i> {{item.actionCount}} {{localize "EMPUZZLES.Actions"}}
                  </span>
                {{/if}}
                {{#if item.variableCount}}
                  <span class="status-badge">
                    <i class="gi-code-fork"></i> {{item.variableCount}} {{localize "EMPUZZLES.Variables"}}
                  </span>
                {{/if}}
                {{#unless item.active}}
                  <span class="status-badge inactive">
                    <i class="gi-pause-button"></i> {{localize "EMPUZZLES.Inactive"}}
                  </span>
                {{/unless}}
              {{/if}}
              {{#if item.hidden}}
                <span class="status-badge hidden">
                  <i class="gi-sight-disabled"></i> {{localize "EMPUZZLES.Hidden"}}
                </span>
              {{/if}}
              {{#if item.locked}}
                <span class="status-badge locked">
                  <i class="gi-padlock"></i> {{localize "EMPUZZLES.Locked"}}
                </span>
              {{/if}}
            </div>
          </div>
        {{/if}}
      {{/each}}
    </div>
  {{else}}
    <p class="no-tiles-message">
      <em>{{localize "EMPUZZLES.NoTilesOnScene"}}</em>
    </p>
  {{/if}}

  <div class="tile-manager-footer">
    <div class="footer-content">
      <a href="https://www.patreon.com/c/DormanLakely" target="_blank" class="patreon-link" title="{{localize 'EMPUZZLES.SupportOnPatreon'}}">
        <i class="fab fa-patreon"></i> {{localize "EMPUZZLES.SupportOnPatreon"}}
      </a>
      <div class="version-info">
        <span class="version-text">v{{version}} (Build {{buildNumber}})</span>
      </div>
    </div>
  </div>
</div>
