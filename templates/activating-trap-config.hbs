<form>
  <div class="form-group">
    <label for="trapName">{{localize "EMPUZZLES.TrapName"}}</label>
    <input type="text" id="trapName" name="trapName" value="{{trapName}}" placeholder="{{localize 'EMPUZZLES.TrapNamePlaceholder'}}" />
    <p class="hint">{{localize "EMPUZZLES.TrapNameHint"}}</p>
  </div>

  <div class="form-group">
    <label for="startingImage">{{localize "EMPUZZLES.StartingImage"}}</label>
    <div class="form-fields">
      <input type="text" id="startingImage" name="startingImage" value="{{defaultTrapImage}}" placeholder="path/to/floor.png" data-dtype="String" />
      <button type="button" class="file-picker" data-type="imagevideo" data-target="startingImage" title="Browse Files" tabindex="-1">
        <i class="fas fa-file-import fa-fw"></i>
      </button>
    </div>
    <p class="hint">{{localize "EMPUZZLES.StartingImageHint"}}</p>
  </div>

  <div class="form-group">
    <label for="sound">{{localize "EMPUZZLES.Sound"}}</label>
    <div class="form-fields">
      <input type="text" id="sound" name="sound" value="{{defaultSound}}" data-dtype="String" />
      <button type="button" class="file-picker" data-type="audio" data-target="sound" title="Browse Files" tabindex="-1">
        <i class="fas fa-file-import fa-fw"></i>
      </button>
    </div>
    <p class="hint">{{localize "EMPUZZLES.SoundHint"}}</p>
  </div>

  <div class="form-group">
    <label for="minRequired">{{localize "EMPUZZLES.MinRequired"}}</label>
    <input type="number" id="minRequired" name="minRequired" value="" min="1" data-dtype="Number" />
    <p class="hint">{{localize "EMPUZZLES.MinRequiredHint"}}</p>
  </div>

  <div class="form-group">
    <label for="targetType">{{localize "EMPUZZLES.TargetType"}}</label>
    <select id="targetType" name="targetType">
      {{#each targetTypeOptions as |option|}}
        <option value="{{option.value}}" {{#if (eq option.value ../defaultTargetType)}}selected{{/if}}>
          {{localize option.label}}
        </option>
      {{/each}}
    </select>
    <p class="hint">{{localize "EMPUZZLES.TargetTypeHint"}}</p>
  </div>

  <div class="form-group">
    <label>
      <input type="checkbox" id="hasSavingThrow" name="hasSavingThrow" data-saving-throw-checkbox {{#if defaultHasSavingThrow}}checked{{/if}} {{#if hasDmgTrap}}disabled{{/if}} />
      {{localize "EMPUZZLES.HasSavingThrow"}}
    </label>
    <p class="hint">{{localize "EMPUZZLES.HasSavingThrowHint"}}</p>
  </div>

  {{! DMG Trap Item Integration }}
  <div class="form-group dmg-trap-section">
    <label>{{localize "EMPUZZLES.DMGTrapItem"}}</label>
    {{#if hasDmgTrap}}
      <div class="dmg-trap-item-display">
        <div class="dmg-trap-item-info">
          <img src="{{dmgTrap.itemImg}}" class="dmg-trap-item-image" alt="" />
          <div class="dmg-trap-item-details">
            <span class="dmg-trap-item-name">{{dmgTrap.itemName}}</span>
            <button type="button" class="dmg-trap-remove-button" data-action="removeDmgTrapItem" title="{{localize 'EMPUZZLES.RemoveDMGTrapItem'}}">
              <i class="fas fa-times"></i> {{localize "EMPUZZLES.Remove"}}
            </button>
          </div>
        </div>
        <div class="dmg-trap-activity-select-wrapper">
          <label for="dmgTrapActivity">{{localize "EMPUZZLES.DMGTrapLevelRange"}}</label>
          <select id="dmgTrapActivity" name="dmgTrapActivity" data-dmg-trap-activity-select>
            {{#each dmgTrap.activityOptions as |activity|}}
              <option value="{{activity.value}}" {{#if (eq activity.value ../dmgTrap.selectedActivityId)}}selected{{/if}}>
                {{activity.label}}
              </option>
            {{/each}}
          </select>
        </div>
      </div>
    {{else}}
      <div class="dmg-trap-item-drop-zone" data-dmg-trap-drop-zone>
        <i class="fas fa-file-import"></i>
        <p>{{localize "EMPUZZLES.DMGTrapDropZone"}}</p>
      </div>
    {{/if}}
    <p class="hint">{{localize "EMPUZZLES.DMGTrapActivatingHint"}}</p>
  </div>

  <div class="saving-throw-fields" style="display: none;">
    <div class="form-group">
      <label for="savingThrow">{{localize "EMPUZZLES.SavingThrow"}}</label>
      <select id="savingThrow" name="savingThrow" {{#if hasDmgTrap}}disabled{{/if}}>
        {{#each savingThrowOptions as |option|}}
          <option value="{{option.value}}" {{#if (eq option.value (or ../defaultSavingThrow "ability:dex"))}}selected{{/if}}>
            {{localize option.label}}
          </option>
        {{/each}}
      </select>
      <p class="hint">{{localize "EMPUZZLES.SavingThrowHint"}}</p>
    </div>

    <div class="form-group">
      <label for="dc">{{localize "EMPUZZLES.DC"}}</label>
      <input type="number" id="dc" name="dc" value="{{or defaultDC 14}}" min="1" max="30" data-dtype="Number" {{#if hasDmgTrap}}disabled{{/if}} />
      <p class="hint">{{localize "EMPUZZLES.DCHint"}}</p>
    </div>
  </div>

  <div class="form-group">
    <label>{{localize "EMPUZZLES.TilesToActivate"}}</label>
    <button type="button" data-action="addTile" class="add-tile-button">
      <i class="fas fa-plus"></i> {{localize "EMPUZZLES.AddTile"}}
    </button>
    <p class="hint">{{localize "EMPUZZLES.ActivatingTrapTilesHint"}}</p>
  </div>

  {{#if hasTiles}}
    <div class="activating-tile-list">
      {{#each tiles as |tile|}}
        <div class="tile-entry activating-tile-config" data-tile-id="{{tile.id}}">
          <div class="tile-header">
            <div class="tile-info">
              {{#if tile.image}}
                {{#if tile.isVideo}}
                  <video src="{{tile.image}}" class="tile-thumbnail" autoplay loop muted></video>
                {{else}}
                  <img src="{{tile.image}}" class="tile-thumbnail" alt="" />
                {{/if}}
              {{else}}
                <img src="icons/svg/hazard.svg" class="tile-thumbnail tile-thumbnail-placeholder" alt="" />
              {{/if}}
              <div class="tile-details">
                <strong class="tile-name">{{tile.name}}</strong>
                <div class="tile-status">
                  {{#if tile.hasMonksData}}
                    <span class="status-badge monks-active">
                      <i class="fas fa-puzzle-piece"></i> {{localize "EMPUZZLES.MonksActiveTile"}}
                    </span>
                    {{#if tile.actionCount}}
                      <span class="status-badge">
                        <i class="fas fa-bolt"></i> {{tile.actionCount}} {{localize "EMPUZZLES.Actions"}}
                      </span>
                    {{/if}}
                    {{#if tile.variableCount}}
                      <span class="status-badge">
                        <i class="fas fa-code"></i> {{tile.variableCount}} {{localize "EMPUZZLES.Variables"}}
                      </span>
                    {{/if}}
                    {{#unless tile.active}}
                      <span class="status-badge inactive">
                        <i class="fas fa-pause"></i> {{localize "EMPUZZLES.Inactive"}}
                      </span>
                    {{/unless}}
                  {{/if}}
                </div>
              </div>
            </div>
            <button type="button" data-action="removeTile" data-tile-id="{{tile.id}}" class="remove-tile-button" title="{{localize 'EMPUZZLES.RemoveTile'}}">
              <i class="fas fa-times"></i>
            </button>
          </div>

          <div class="tile-action-config">
            <div class="form-group compact">
              <label for="action-{{tile.id}}">{{localize "EMPUZZLES.Action"}}</label>
              <select id="action-{{tile.id}}" name="action-{{tile.id}}" data-action-select data-tile-id="{{tile.id}}">
                <option value="activate" {{#if (eq tile.actionType "activate")}}selected{{/if}}>{{localize "EMPUZZLES.ActionActivate"}}</option>
                <option value="showhide" {{#if (eq tile.actionType "showhide")}}selected{{/if}}>{{localize "EMPUZZLES.ActionShowHide"}}</option>
                <option value="moveto" {{#if (eq tile.actionType "moveto")}}selected{{/if}}>{{localize "EMPUZZLES.ActionMoveTo"}}</option>
              </select>
            </div>

            <div class="activate-options action-options" style="{{#unless (eq tile.actionType "activate")}}display: none;{{/unless}}">
              <div class="form-group compact">
                <label for="activateMode-{{tile.id}}">{{localize "EMPUZZLES.Mode"}}</label>
                <select id="activateMode-{{tile.id}}" name="activateMode-{{tile.id}}" data-mode-select data-mode-type="activate" data-tile-id="{{tile.id}}">
                  <option value="activate" {{#if (eq tile.activateMode "activate")}}selected{{/if}}>{{localize "EMPUZZLES.Activate"}}</option>
                  <option value="deactivate" {{#if (eq tile.activateMode "deactivate")}}selected{{/if}}>{{localize "EMPUZZLES.Deactivate"}}</option>
                  <option value="toggle" {{#if (eq tile.activateMode "toggle")}}selected{{/if}}>{{localize "EMPUZZLES.Toggle"}}</option>
                </select>
              </div>
            </div>

            <div class="showhide-options action-options" style="{{#unless (eq tile.actionType "showhide")}}display: none;{{/unless}}">
              <div class="form-group compact">
                <label for="showHideMode-{{tile.id}}">{{localize "EMPUZZLES.Mode"}}</label>
                <select id="showHideMode-{{tile.id}}" name="showHideMode-{{tile.id}}" data-mode-select data-mode-type="showhide" data-tile-id="{{tile.id}}">
                  <option value="show" {{#if (eq tile.showHideMode "show")}}selected{{/if}}>{{localize "EMPUZZLES.Show"}}</option>
                  <option value="hide" {{#if (eq tile.showHideMode "hide")}}selected{{/if}}>{{localize "EMPUZZLES.Hide"}}</option>
                  <option value="toggle" {{#if (eq tile.showHideMode "toggle")}}selected{{/if}}>{{localize "EMPUZZLES.Toggle"}}</option>
                </select>
              </div>
            </div>

            <div class="move-options action-options" style="{{#unless (eq tile.actionType "moveto")}}display: none;{{/unless}}">
              <div class="form-group compact">
                <label>{{localize "EMPUZZLES.MoveDestination"}}</label>
                <button type="button" class="select-position-button" data-action="selectMovePosition" data-tile-id="{{tile.id}}">
                  <i class="fas fa-crosshairs"></i> {{localize "EMPUZZLES.SelectPosition"}}
                </button>
                <p class="hint move-position-display">
                  {{#if tile.moveX}}
                    {{localize "EMPUZZLES.SelectedPosition"}}: ({{tile.moveX}}, {{tile.moveY}})
                  {{else}}
                    {{localize "EMPUZZLES.NoPositionSelected"}}
                  {{/if}}
                </p>
              </div>
            </div>
          </div>
        </div>
      {{/each}}
    </div>
  {{else}}
    <p class="no-tiles">{{localize "EMPUZZLES.NoTilesSelected"}}</p>
  {{/if}}

  <div class="form-group">
    <label>{{localize "EMPUZZLES.WallDoorActions"}}</label>
    <button type="button" data-action="addWall" class="add-tile-button">
      <i class="fas fa-plus"></i> {{localize "EMPUZZLES.AddWall"}}
    </button>
    <p class="hint">{{localize "EMPUZZLES.WallDoorActionsHint"}}</p>
  </div>

  {{#if hasWalls}}
    <div class="wall-list">
      {{#each walls as |wall index|}}
        <div class="wall-entry" data-wall-index="{{@index}}">
          <div class="wall-info">
            <i class="fas fa-door-open"></i>
            <span class="wall-id">{{wall.wallId}}</span>
          </div>
          <div class="wall-state-selector">
            <label for="wall-state-{{@index}}">{{localize "EMPUZZLES.State"}}:</label>
            <select id="wall-state-{{@index}}" name="wall-state-{{@index}}">
              <option value="OPEN" {{#if (eq wall.state "OPEN")}}selected{{/if}}>{{localize "EMPUZZLES.DoorOpen"}}</option>
              <option value="CLOSED" {{#if (eq wall.state "CLOSED")}}selected{{/if}}>{{localize "EMPUZZLES.DoorClosed"}}</option>
              <option value="LOCKED" {{#if (eq wall.state "LOCKED")}}selected{{/if}}>{{localize "EMPUZZLES.DoorLocked"}}</option>
            </select>
          </div>
          <button type="button" data-action="removeWall" data-wall-index="{{@index}}" class="remove-wall-button" title="{{localize 'EMPUZZLES.RemoveWall'}}">
            <i class="fas fa-times"></i>
          </button>
        </div>
      {{/each}}
    </div>
  {{else}}
    <p class="no-tiles">{{localize "EMPUZZLES.NoWallsSelected"}}</p>
  {{/if}}
</form>
